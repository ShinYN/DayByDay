# AOP
## 개념 

개념
- 흩어져있는 관심들을 하나로 모으는 것


주요 개념
- Aspect: 모듈 
- Advice: 해야할 일들
- Target: Aspect가 가지고 있는 Advice가 적용 되는 대상
- Pointcut: 어디에 적용을 해야하는지
- Join Point: 끼어들 수 있는 시점
   - 예: 메서드가 실행할 때, 생성자 호출 직전

AOP 구현체
- Java:
   - AspectJ
   - 스프링 AOP

적용 방법
- 컴파일 타임:
- 로드 타임: 
- 런타임: 


## 프록시 기반 AOP

프록시 패턴
- 목적: 접근제어, 부가 기능 추가
- 구조
   - Client -> _Subject_ <- Proxy, Real Subject
   - Proxcy -> Real Subject

동적 프록시
- AbstractAutoProxyCreator

프록시 등록 샘플
1. Interface
    ~~~java
    public interface EventService {

        void createEvent();

        void publishEvent();

        void deleteEvent();
    }
    ~~~

2. Interface 구현체
    ~~~java
    @Service
    public class SimpleEventService implements EventService{

        @Override
        public void createEvent() {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

            System.out.println("Created an event");
        }

        @Override
        public void publishEvent() {

            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

            System.out.println("Published an event");
        }

        @Override
        public void deleteEvent() {
            System.out.println("Delete event");
        }
    }
    ~~~
3. 프록시
    ~~~java
    @Primary
    @Service
    public class ProxySimpleEventService implements EventService {

        @Autowired
        SimpleEventService simpleEventService;  // Real Subject를 받는다

        @Override
        public void createEvent() {
            long begin = System.currentTimeMillis();
            simpleEventService.createEvent();
            System.out.println(System.currentTimeMillis() - begin);
        }

        @Override
        public void publishEvent() {
            long begin = System.currentTimeMillis();
            simpleEventService.publishEvent();
            System.out.println(System.currentTimeMillis() - begin);
        }

        @Override
        public void deleteEvent() {
            simpleEventService.deleteEvent();
        }
    }

    ~~~


## 스프링 AOP

어디바이스 정의
- @Arount
- @Before
- @AfterReturning
- @AfterThrowing

참고
- 스프링 공식문서

### 과정

방법 1 : 모든 메서드에 적용되는 문제가 있다
1. 의존성 등록
    ~~~java
    implementation 'org.springframework.boot:spring-boot-starter-aop' 
    ~~~
2. Aspect 클래스 등록
~~~java
@Component  // 빈으로 등록하기 위해
@Aspect // 모듈
public class PerfAspect {

    //해야할 일 (Advice)
    @Around("execution(* me.ycshin..*.EventService.*(..))") // 어드바이스 정의 및 포인트컷 정의
    public Object logPerf(ProceedingJoinPoint pjp) throws Throwable{
        long begin = System.currentTimeMillis();
        Object retVal = pjp.proceed();
        System.out.println(System.currentTimeMillis() - begin);
        return  retVal;
    }
}
~~~

방법 2 : Annotation을 만들어서 처리
1. Annotation 구현
    ~~~java
    @Documented
    @Retention(RetentionPolicy.CLASS)
    @Target(ElementType.METHOD)
    public @interface PerfLogging {
    }

    ~~~

2. Annotation을 사용할 메서드에 선언
    ~~~java
    @PerfLogging
    @Override
    public void createEvent() {
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println("Created an event");
    }
    ~~~

3. Aspect에 Advice 정의
    ~~~java
    @PerfLogging
    @Override
    public void createEvent() {
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println("Created an event");
    }
    ~~~