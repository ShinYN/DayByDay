# 도메인 영역의 주요 구성요소
엔티티
- 고유식별자를 갖는 객체로 자신의 라이프사이클을 갖는다
- 주문, 회원, 상품과 같이 도메인의 고유한 개념을 표현한다
- 모데인모델의 엔티티는 단순히 데이터만 가지는 것이 아니라 기능도 함께 제공한다는 측면에서 DB의 엔티티와 다르다

밸류
- 고유의 식별자를 갖지 않는 객체
- 주로 개념적으로 하나의 도메인 객체의 속성을 표현할 때 사용된다
   - 예: 주소, 금액 등
- 엔티티의 속성으로 사용되거나 다른 밸류타입의 속성으로 사용될 수 있다

애그리거트
- 관련된 엔티티와 밸류 객체를 개념적으로 하나로 묶은 것
- 예: 주문과 관련된 OrderEntity, OrderLine 밸류, Orderer 밸류 객체를 `주문` 애그리거트로 묶을 수 있다
- 애그리거트 루트
   - 군집속에 속한 객체들을 관리하는 루트엔티티
   - 애그리거트를 사용한 코드는 애그리거트 루트를 통해서 간접적으로 애그리거트 내의 다른 엔티티나 밸류 객체에 접근하게 된다
   - 예: 주문 애그리거트는 Order를 통하지 않고 ShippingInfo를 변경할 수 있는 방법을 제공하지 않는다

도메인 서비스
- 특정 엔티티에 속하지 않는 도메인 로직을 제공한다
- 예: '할인금액계산'은 상품,쿠폰,회원 등 다영한 조건을 이용해서 구현하게 되는데 이러헥 도메인 로직이 여러 엔티티와 벨류를 필요로 할 경우 도메인 서비스에서 로직을 구현한다.

리포지터리
- 애그리거트 단위로 도메인 객체를 저장하고 조회하는 기능을 정의한다
- Repository는 영속화에 필요한 기능을 추상화한 것으로 Domain 모델 영역에 속하고, 이를 구현한 구현체는 Infra영역에 속한다

요청 처리의 흐름
!["2-20"](/image/2-20.jpg)

# 애그리거트
애그리거트의 경계 설정
- 도메인 규칙에 따라 함께 생성되는 구성요소는 한 애그리거트에 속할 가능성이 높다
- 저자의 경험으로는 다수의 애그리거트가 한 개의 엔티티 객체만 갖는 경우가 많으며 두 개 이상의 엔티티로 구성되는 애그리거트는 드물게 존재한다

애그리거트 루트
- 애그리거트에 속한 모든 객체가 일관된 상태를 유지하려면 전체를 관리할 주체가 필요한데 이 책임을 지는 것이 루트엔티티이다
- 핵심은 애그리거트의 일관성이 깨지지 않도록 하는 것이다
- 애그리거트 루트가 아닌 다른 객체가 애그리거트에 속한 객체를 직접 변경해서는 안된다. 
- 규칙
   1. 단순히 필드를 변경하는 set은 public으로 만들지 않는다
   2. 밸류 타입은 불변으로 구현한다

트랜잭션의 범위
- 작을수록 좋다
- 한 트랜잭션에서는 한개의 애그리거트만 수정해야 한다. (=애그리거트가 다른 애그리거트를 변경하지 않는다는 것)
   - 부득이하게 한 트랜잭션에서 2개의 애그리거트를 수정해야 한다면 애그리거트에서 다른 애그리거트를 수정하지 말고, 응용서비스 영역에서 두 애그리거트를 수정하도록 한다. 
   - 도메인 이벤트와 비동기를 방식으로 해결 할 수도 있다.